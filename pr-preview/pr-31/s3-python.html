<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/macro-2018/pr-preview/pr-31/assets/css/style.css?v=4daec8ed68e5d4a37fd68f9adc54b87940d77df4">
    <link rel="icon" type="image/png" href="/macro-2018/pr-preview/pr-31/assets/favicons/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/macro-2018/pr-preview/pr-31/assets/favicons/favicon.svg" />
    <link rel="shortcut icon" href="/macro-2018/pr-preview/pr-31/assets/favicons/favicon.ico" sizes="48x48 32x32" />
    <link rel="apple-touch-icon" sizes="180x180" href="/macro-2018/pr-preview/pr-31/assets/favicons/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="MACRO-2018" />
    <link rel="manifest" href="/macro-2018/pr-preview/pr-31/assets/favicons/site.webmanifest" />
    <meta name="google-site-verification" content="FDsDvatXtMDAoGR0-B-hQSvLF7Pb1Zl0_986ettSGxI" />
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>S3 Access using Python | MACRO-2018</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="S3 Access using Python" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The MACRO-2018 dataset is a high-resolution dataset of CO and CO2 concentrations in metropolitan areas in Germany in 2018." />
<meta property="og:description" content="The MACRO-2018 dataset is a high-resolution dataset of CO and CO2 concentrations in metropolitan areas in Germany in 2018." />
<link rel="canonical" href="https://atmo-iup-uhei.github.io/macro-2018/pr-preview/pr-31/s3-python.html" />
<meta property="og:url" content="https://atmo-iup-uhei.github.io/macro-2018/pr-preview/pr-31/s3-python.html" />
<meta property="og:site_name" content="MACRO-2018" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="S3 Access using Python" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"The MACRO-2018 dataset is a high-resolution dataset of CO and CO2 concentrations in metropolitan areas in Germany in 2018.","headline":"S3 Access using Python","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://atmo-iup-uhei.github.io/macro-2018/pr-preview/pr-31/assets/favicon.ico"}},"url":"https://atmo-iup-uhei.github.io/macro-2018/pr-preview/pr-31/s3-python.html"}</script>
<!-- End Jekyll SEO tag -->

  </head>
  <body>
    <header class="page-header" role="banner">
      <div class="page-header-bg">
        <div class="page-header-bg-eur">
          <img src="/macro-2018/pr-preview/pr-31/assets/images/TNO_eur.png " />
        </div>
        <img src="/macro-2018/pr-preview/pr-31/assets/images/TNO_ger.png " />
      </div>
      <div class="headline">
        <h1 class="project-name">MACRO-2018</h1>
      </div>
      <h2 class="project-tagline"><b>M</b>etropolitan <b>A</b>rea <b>C</b>O<sub>x</sub> <b>R</b>ec<b>O</b>rd of Germany 2018</h2>
    </header>

    <button id="hamburger-menu" onclick="toggleSidebar()">â˜°</button>

    <div class="sidebar" id="sidebar">
      <ul>
        <li><a href="/macro-2018/pr-preview/pr-31/">Home</a></li>
        <li><a href="/macro-2018/pr-preview/pr-31/documentation.html">Documentation</a></li>
        <li>Data Access</li>
        <ul>
          <li><a href="https://doi.org/10.26050/WDCC/MACRO-2018">WDCC</a></li>
          <li><a href="/macro-2018/pr-preview/pr-31/s3-python.html">S3/Python</a></li>
        </ul>
      </ul>
    </div>

    <main id="content" class="main-content" role="main">
      <h2 id="data-storage">Data Storage</h2>

<p>This version of the MACRO-2018 data is stored as a chunked <a href="https://zarr.dev"><code class="language-plaintext highlighter-rouge">zarr</code></a> dataset in a S3-Bucket on servers of the <a href="https://dkrz.de">DKRZ</a>.
It is available under the following URL</p>

<dl>
  <dt>Endpoint</dt>
  <dd><code class="language-plaintext highlighter-rouge">https://s3.eu-dkrz-1.dkrz.cloud/</code></dd>
  <dt>Path</dt>
  <dd><code>/bb1170/public/MACRO-2018/<b>[MYJ/YSU]</b>/wrfout_d<b>0X</b>.zarr&lt;\code&gt;</code></dd>
</dl>

<p>Here, the <code class="language-plaintext highlighter-rouge">[MYJ/YSU]</code> string stands for the MYJ or YSU boundary layer scheme the data was generated with and d<code class="language-plaintext highlighter-rouge">0X</code> indicates the requested domain (cf. <a href="documentation.html">documentation</a>).
This <code class="language-plaintext highlighter-rouge">zarr</code> object on the S3-Bucket can be accessed in many different languages.
In the following, I show how to access it using Python.</p>

<h2 id="preparing-your-environment-using-conda">Preparing your environment using Conda</h2>

<p>In order to be able to access the S3 filesystem, you need the following packages to be available.
Save this as a file called <code class="language-plaintext highlighter-rouge">macro_access.yml</code> and then create a new conda environment using <code class="language-plaintext highlighter-rouge">conda env create -f macro_access.yml</code>.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>name: macro_access
channels:
  - conda-forge
  - defaults
dependencies:
  - python=3.12
  - pip
  - xarray
  - zarr=2.18.5
  - s3fs
</code></pre></div></div>
<p>Now, activate the newly created environment using <code class="language-plaintext highlighter-rouge">conda activate macro_access</code>.</p>

<h2 id="accessing-the-data">Accessing the data</h2>

<p>With the dependencies installed and the environment activated, we can access the data.
First we import the necessary packages and choose the data we want to look at:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import xarray as xr
domain = 4  # Berlin
blscheme = "MYJ"
</code></pre></div></div>
<p>More information regarding the domains can be found <a href="documentation.html#domain-setup">here</a>.
Then, we access the DKRZ S3 store using caching in order to reduce latency and traffic.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>s3_path = f"s3://bb1170/public/MACRO-2018/{blscheme}/wrfout_d{domain:02d}.zarr"

s3_options = dict(
        anon=True,
        client_kwargs=dict(
            endpoint_url="https://s3.eu-dkrz-1.dkrz.cloud/"
        )
    )
cache_options = dict(
        cache_storage="/tmp/zarr_cache"
    )

# Open the datatree directly
ds = xr.open_datatree(
        f"simplecache::{s3_path}",
        engine="zarr",
        consolidated=True,
        storage_options=dict(
            s3=s3_options,
            simplecache=cache_options,
        )
    )
</code></pre></div></div>
<p>Finally we can use the remote data like it were on our computer locally.
The available data including WRF tracer fields, meteorology and statistics are described in the <a href="documentation.html#data-structure">documentation page</a>.</p>


      <footer class="site-footer">
        
          <span class="site-footer-owner"><a href="https://github.com/ATMO-IUP-UHEI/macro-2018">macro-2018</a> is maintained by <a href="https://github.com/ATMO-IUP-UHEI">ATMO-IUP-UHEI</a>.</span>
        
        <span class="site-footer-credits">This page was built by Lukas Pilz and generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>

    <script>
      function toggleSidebar() {
        var sidebar = document.getElementById('sidebar');
        if (sidebar.style.display === 'block') {
          sidebar.style.display = 'none';
        } else {
          sidebar.style.display = 'block';
        }
      }
    </script>
  </body>
</html>
